# Heatmap Generation Configuration for MIL-Lab
# Usage: python create_heatmaps.py --config heatmaps/configs/config_template.yaml

---
exp_arguments:
  # Number of output classes
  n_classes: 2

  # Experiment name for organizing outputs
  save_exp_code: HEATMAP_DEMO

  # Directory for raw assets (attention scores, coordinates, etc.)
  raw_save_dir: heatmaps/heatmap_raw_results

  # Directory for final heatmap visualizations
  production_save_dir: heatmaps/heatmap_production_results

  # Batch size for feature extraction (if needed)
  batch_size: 256

data_arguments:
  # Path to whole slide images
  # Can be a single directory path (str) or a dict mapping {key: path}
  data_dir: /path/to/slides/

  # If data_dir is a dict, this specifies the column name in process_list CSV
  # that contains the key for looking up the correct directory
  data_dir_key: source

  # CSV file with slide_id column listing slides to process
  # Can also include optional columns: label, features_path, coords_path
  # If null, will process all slides in data_dir
  process_list: null

  # File extension for slides
  slide_ext: .svs

  # Directory containing pre-extracted features
  # Expected format: {features_dir}/{slide_id}.pt
  features_dir: features/h5_files

  # Optional label dictionary for mapping class names to integers
  label_dict:
    normal: 0
    tumor: 1

patching_arguments:
  # Patch size at level 0
  patch_size: 256

  # Overlap between patches (0.0 = no overlap, 0.5 = 50% overlap)
  overlap: 0.0

  # Pyramid level at which patches were extracted
  patch_level: 0

  # Custom downsampling factor applied during patching
  custom_downsample: 1

model_arguments:
  # Path to model checkpoint
  ckpt_path: /path/to/checkpoint.pt

  # Model architecture configuration
  # This should match the config used during training
  model_type: abmil

  # Model-specific parameters
  n_classes: 2
  in_dim: 1024

  # ABMIL-specific
  attention_dim: 256
  dropout: 0.25

  # For CLAM models
  # model_type: clam_sb
  # bag_loss: ce
  # instance_loss_fn: svm
  # B: 8

heatmap_arguments:
  # Pyramid level for visualization (-1 = auto-select best level ~32x downsample)
  vis_level: -1

  # Transparency for blending heatmap with original image
  # 0.0 = show only background, 1.0 = show only heatmap
  alpha: 0.4

  # Use blank canvas instead of original slide image
  blank_canvas: false

  # Whether to save the original H&E image alongside heatmap
  save_orig: true

  # File extension for saved images (png, jpg, tiff)
  save_ext: png

  # Convert attention scores to percentiles for better contrast
  convert_to_percentiles: true

  # Apply Gaussian blur for smoother heatmaps
  blur: false

  # Binarize attention scores (show only patches above threshold)
  binarize: false

  # Threshold for binarization (0-1, or -1 for auto = 1/num_patches)
  binary_thresh: -1

  # Additional downsampling factor for final heatmap
  custom_downsample: 1

  # Matplotlib colormap name
  # Options: jet, coolwarm, viridis, plasma, inferno, magma, hot, etc.
  cmap: jet

sample_arguments:
  # Sample and save individual patches based on attention scores
  samples:
    - name: "top_attention_patches"
      sample: true
      k: 15              # Number of patches to sample
      mode: topk         # Sampling mode: topk, random, etc.
      seed: 1            # Random seed for reproducibility
